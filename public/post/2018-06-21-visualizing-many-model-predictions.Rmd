---
title: Visualizing (many) model predictions
author: Joe Powers
date: '2018-06-21'
slug: visualizing-many-model-predictions
categories: []
tags: []
description: ''
featured: ''
featuredalt: ''
featuredpath: ''
linktitle: ''
---

```{r message=FALSE}
library(tidyverse)
library(magrittr)
library(modelr)
```

```{r}
ds_mt <- mtcars
```

```{r}
p_mpg <- 
  ds_mt %>% 
  ggplot(aes(x = wt, y = mpg)) + 
  geom_point()

p_mpg
```

```{r}
m1 <- lm(mpg ~ wt, ds_mt)
m2 <- lm(mpg ~ wt + I(wt^2), ds_mt)
```

```{r}
ds_mt %<>% 
	add_predictions(m1, var = "m1_pred") %>% 
  add_predictions(m2, var = "m2_pred")
```

## Show a predicted model using raw data to demo need for a full dataset. 
```{r}
p_mpg + 
  geom_point(
    data = ds_mt, 
    aes(x = wt, y = m2_pred), 
    color = "red"
  )
```

## show how to make a full dataset
Creates 10 values for each var that are equally spaced along its range. 10 x 10 = 100 rows
```{r create grid of predicted values}
ds_mtgrid <- 
  data_grid(
    ds_mt, 
    wt = seq_range(wt, 500), 
    mpg = seq_range(mpg, 100)
  )
```

```{r add_predictions}
ds_mtgrid %<>% 
	add_predictions(m1, var = "m1_pred") %>% 
  add_predictions(m2, var = "m2_pred")
```

```{r 2 plots}
p_mpg + 
    geom_point(
      data = ds_mtgrid, 
      aes(x = wt, y = m1_pred), 
      size = .1, 
      color = "blue"
    ) + 
    geom_point(
      data = ds_mtgrid,
      aes(x = wt, y = m2_pred), 
      size = .1, 
      color = "red"
    )
```

The above plot makes is too cluttered, so let's gather the predicted values into one column so we can facet the data into seperate plots.
```{r gather_mpg_pred}
ds_mtgrid %<>% 
  gather(m1_pred, m2_pred, key = model, value = mpg_pred) 
```

```{r facetted_plot, fig.height=4, fig.width=10}
p_mpg + 
  geom_point(
    data = ds_mtgrid, 
    aes(x = wt, y = mpg_pred), 
    size = .1, 
    color = "red"
  ) + 
  facet_grid(~model)
```

# gather_predictions()

Suppose we had even more models we wanted to test. 
```{r}
m1 <- lm(mpg ~ wt, data = ds_mt)
m2 <- lm(mpg ~ wt + I(wt^2), data = ds_mt)
m3 <- lm(mpg ~ wt + I(wt^2) + I(wt^3), data = ds_mt)
m4 <- lm(mpg ~ wt + I(wt^2) + I(wt^3) + I(wt^4), data = ds_mt)
```

We can use `gather_predictions()` to add the predicted outcomes to our dataset.
```{r gather_predictions}
ds_mtgrid %<>% 
  gather_predictions(m1, m2, m3, m4, .pred = "mpg_pred")
```

```{r many plots}
p_mpg + 
  geom_point(
    data = ds_mtgrid, 
    aes(x = wt, y = mpg_pred), 
    size = .1, 
    color = "red"
  ) + 
  facet_wrap(~model)
```

# On return try to pull R.squared from many models

Many models has two basic approaches. You can apply the same model to many subsets, or you can apply multiple models to the same data. 

## Applying the same model to many subsets
```{r same model to subsets of one df}
# Create a nested dataframe
ds_by_cyl <- 
  ds_mt %>% 
  group_by(cyl) %>% 
  nest()

# Create a model to apply as a function within map()
my_model <- function(mydata){
  lm(mpg ~ wt, data = mydata)
}

# create a model for each dataframe in your list column called "data"
ds_by_cyl %<>% 
  mutate(model = map(data, my_model))

# Exract key model stats using `broom::glance()`
ds_by_cyl %<>% 
  mutate(model_stats = map(model, broom::glance))

# Unnest the `model_stats` list column so you can plot relevant stat from each model
ds_by_cyl %>% 
  unnest(model_stats) %>% 
  ggplot(aes(x = cyl, y = r.squared)) + 
  geom_line() + 
  geom_point(color = "red") +
  scale_x_continuous(breaks = seq(4,8, by = 2)) + 
  labs(title = "Weight explain more odf the variance in mpg for smaller engine cars")
```

Can you save the df in each list-col cell from Diamonds Part 4: 
https://github.com/dcl-2017-04/tasks/blob/master/c27-diamonds-4/solution.md
```{r many models to one df}
ds_mt %<>% rownames_to_column("vehicle") 

model_stats <- function(formula, mydata = ds_mt) {
  v <- lm(formula, data = mydata)
  
  tibble(
    formula = formula,
    n_coefs = coef(v) %>% length(),
    r_squared = broom::glance(v)$r.squared
  )
}

many_models <- 
  list(
    "mpg ~ wt",
    "mpg ~ wt + disp",
    "mpg ~ wt + disp + am",
    "mpg ~ wt + disp + vs",
    "mpg ~ wt + disp + am + vs"
  ) 

ds_models <- map_df(many_models, model_stats)

ds_models %>% 
  ggplot(aes(x = n_coefs, y = r_squared, label = formula)) + 
  geom_line() + 
  geom_point() + 
  ggrepel::geom_text_repel(point.padding = 1) + 
  coord_cartesian(xlim = c(1.75, 5.5)) + 
  labs(title = "AM adds little to model")
```

# Can you store all those plots in one tibble? 
```{r}

```



